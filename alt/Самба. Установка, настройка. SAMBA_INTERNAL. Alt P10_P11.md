> Источник: [Из документации альта](https://www.altlinux.org/SambaAD_start#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_Samba)
>
> Если что-то по вашему мнению сломалось, то в самбе можно все откатить, ___почистив папочки самбы и рестартнув самбу___.
>
> Даже если ошибки - фиолетово, после `samba-tool domain provision` и рестарта все починится.
>
> 

Сначала стоит задать `hostname` для нового КД:
```bash
hostnamectl hostname dc.domain.name
exec bash # Для обновления шелла новым
```

Установка самбы происходит через метапакет:
```bash
apt-get install task-samba-dc bind-utils -y
```

Перед всеми действиями ___ОБЯЗАТЕЛЬНО___ надо почистить папочки самбы:
```bash
rm -f /etc/samba/smb.conf
rm -rf /var/lib/samba
rm -rf /var/cache/samba
mkdir -p /var/lib/samba/sysvol
```

Также, чтобы работал DNS для установки всякого, надо выставить DNS сервер - `127.0.0.1`, настраивать в зависимости от подсистемы управления сетевыми интерфейсами.

После этого можно приступить к созданию домена:
```bash
samba-tool domain provision
```

1. Первые два пункта можно уверенно пропустить (Enter), если hostname был настроен. Ну или просто задать вручную.
2. Роль в домене: указывается кем будет это устройство в домене. В данном случае - DC (КД, контроллер домена).
3. `DNS_BACKEND` в самой простой реализации оставляем по умолчанию (`SAMBA_INTERNAL`), остальное не нужно.
4. DNS сервер для пересылки - куда будут пересылаться все непонятные DNS запросы (если наш КД не знает о `pornhub.com`, то именно на этот сервер и перенаправится запрос). Если непонятно че написал я здесь написал - то просто пишем `8.8.8.8`.
5. Потом пароль. Если не сказано делать его каким-то определенным, то просто `P@ssw0rd`, чтобы не париться.

Врубаем самбу:
```bash
systemctl --now enable samba
```

Чтобы получить билет kerberos, нужно в `/etc/krb5.conf` прописать свой домен (KK.RU в этом случае): 
```
default_realm = KK.RU
```
Только после этого можно получить билет, введя пароль:
```
kinit administrator
```
Проверить билет можно через `klist`:
```bash
[root@dc ~]# klist
Ticket cache: KEYRING:persistent:0:0
Default principal: administrator@KK.RU

Valid starting       Expires              Service principal
06.02.2025 23:19:51  07.02.2025 09:19:51  krbtgt/KK.RU@KK.RU
        renew until 13.02.2025 23:19:48
```

После небольшая проверочка, что все работает:
```bash
samba-tool domain info 127.0.0.1
smbclient -L localhost -U administrator
dig kk.ru # Внимательно изучаем, проверяем что записи получены откуда надо
```
